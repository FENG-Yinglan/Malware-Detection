'use strict';



app.controller('Ctrl1',function($scope,$http,$stateParams){

    console.log($stateParams.id);
    $scope.id = $stateParams.id;
    $scope.peizhi = {
        theme:'default',
        dataLoaded:true
    };

    $scope.apixiangqing = {
        "data": [["..."]],
        "columns": [
            { "title": "加载中, 请稍候或刷新页面" }
        ]
    };


    var mubandian=[];
    var mubanbian=[];

    var xjuli = 25;
    var yjuli = 100;
    for (var i=1;i<=1;++i)
      mubandian.push({name:'ROOT', x:i*xjuli*32-xjuli*15.5, y:0*yjuli, ceng:1});
    for (var i=1;i<=2;++i)
      mubandian.push({name:'API-1-'+i, x:i*xjuli*16-xjuli*7.5, y:1*yjuli, ceng:2});
    for (var i=1;i<=4;++i)
      mubandian.push({name:'API-2-'+i, x:i*xjuli*8-xjuli*3.5, y:2*yjuli, ceng:3});
    for (var i=1;i<=8;++i)
      mubandian.push({name:'API-3-'+i, x:i*xjuli*4-xjuli*1.5, y:3*yjuli, ceng:4});
    for (var i=1;i<=16;++i) 
      mubandian.push({name:'API-4-'+i, x:i*xjuli*2-xjuli*0.5, y:4*yjuli, ceng:5});
    for (var i=1;i<=32;++i)
      mubandian.push({name:'OUTPUT-'+i, x:i*xjuli, y:5*yjuli, ceng:6});
    for (var i=0;i<31;++i) {
      mubanbian.push({source: i,target:2*i+1});
      mubanbian.push({source: i,target:2*i+2});
    }

    var dian = [];
    var bian = [];
    var keshu = 3;
    var dajuli = 35*xjuli;
    var zuoyou = 1;
    //生成点
    for (var k=0;k<keshu;++k)
      for (i in mubandian) {
        var biaoqian;
        var zhi;
        if (mubandian[i].ceng<6 && mubandian[i].ceng>1)
          dian.push({
            name: 'Tree'+(k+1)+'-'+mubandian[i].name,
            x: k*dajuli+mubandian[i].x,
            y: mubandian[i].y,
            value: Math.random(),
            label: {
              normal: {
                  show: false
              }
            },
            tooltip: {
                formatter: function (param) {
                    return [
                        '决策树编号：' + param.name.substring(4,5),
                        '特征节点: ' + param.name.substring(6),
                        '权重值: ' + param.value
                    ].join('<br/>');
                }
            },
            ceng: mubandian[i].ceng
          });
        else if (mubandian[i].ceng==1) 
          dian.push({
            name: 'Tree'+(k+1)+'-'+mubandian[i].name,
            x: k*dajuli+mubandian[i].x,
            y: mubandian[i].y,
            value: 1,
            label: {
              normal: {
                  show: true,
                  formatter: function(v){
                    switch (v.data.name) {
                      case "Tree1-ROOT": return "树1";
                      case "Tree2-ROOT": return "树2";
                      case "Tree3-ROOT": return "树3";
                    }
                  }
              }
            },
            ceng: mubandian[i].ceng
          });
        else {
          zuoyou = 1-zuoyou;
          dian.push({
            name: 'Tree'+(k+1)+'-'+mubandian[i].name,
            x: k*dajuli+mubandian[i].x,
            y: mubandian[i].y,
            value: zuoyou,
            label: {
              normal: {
                  show: true,
                  formatter: '{c}',
                  textStyle: {
                    color:'#acacac',
                    fontSize: 12,
                    //fontWeight: 'Bold'
                  }
              }
            },
            itemStyle: {
              normal: {
                color: 'white'
              }
            },
            ceng: mubandian[i].ceng
          });
        }
      }

    dian.push({
      name: 'APK',
      symbol: "rect",
      symbolSize: [200,30],
      x: 16.5*xjuli+dajuli,
      y: -yjuli*2.4,
      ceng : 0.7,
      show: false,
      label: {
          normal: {
              show: true
          }
      },  
      itemStyle: {
        normal: {
          color: 'rgb(39,174,76)'
        }
      }
    });

    dian.push({
      name: '解包',
      x: 16.5*xjuli+dajuli,
      y: -yjuli*1.2,
      ceng : 0.7,
      symbol: "diamond",
      symbolSize: [100,30],
      label: {
          normal: {
              show: true
          }
      },  
      itemStyle: {
        normal: {
          color: '#6089ff'
        }
      }
    });

    dian.push({
      name: 'Vote',
      x: 16.5*xjuli+dajuli,
      y: yjuli*7,
      ceng : 0.7,
      symbol: "diamond",
      symbolSize: [40,40],
      label: {
          normal: {
              show: true
          }
      },  
      itemStyle: {
        normal: {
          color: 'rgb(114,102,186)'
        }
      }
    });

    dian.push({
      name: 'RF模型输出：',
      x: 16.5*xjuli+dajuli,
      y: yjuli*8,
      ceng : 0.7,
      symbol: "rect",
      symbolSize: [200,30],
      label: {
          normal: {
              show: true
          }
      },  
      itemStyle: {
        normal: {
          color: 'rgb(114,102,186)'
        }
      }
    });
    dian.push({
      name: '……',
      x: 5*xjuli+3*dajuli,
      y: yjuli*3,
      ceng : 0.7,
      symbol: "rect",
      symbolSize: [30,30],
      label: {
          normal: {
              show: true,
              textStyle: {
                color:'#c23531',
                fontSize: 18,
                fontWeight: 'Bold'
              }
          }
      },  
      itemStyle: {
        normal: {
          color: 'white'
        }
      }
    });

    bian.push({
          source: 190,
          target: 0
        }); 
    bian.push({
          source: 190,
          target: 126
        });
    bian.push({
          source: 189,
          target: 63
        });

    //生成边
    for (var k=0;k<keshu;++k)
      for (i in mubanbian)
        bian.push({
          source: k*63+mubanbian[i].source,
          target: k*63+mubanbian[i].target
        });

    $http({
      url:'tpl/getshuju.php?'+$stateParams.id,
      method:'GET'
      }).success(function(data,header,config,status){
        console.log(data);
        $scope.time = data.time;
        $scope.shuju = data.shuju;
        $scope.daxiao = data.daxiao;
        console.log($scope.shuju);

        dian[189].name=data.shuju.result.apkname+".apk";
        dian[192].name += data.shuju.result.result;

        var pianyi = $stateParams.id%15*2 + (data.shuju.result.result=='Malware');
        console.log((data.shuju.result.result=='Malware'));
        var zuixiayiceng = [35+pianyi,100+pianyi,160+pianyi];

        for (var z=0;z<3;++z) {
          dian[zuixiayiceng[z]].label.normal.textStyle = {
                  color:'#c23531',
                  fontSize: 12,
                  fontWeight: 'Bold'
          };

          bian.push({
            source: zuixiayiceng[z],
            target: 191
          });
        }

        $scope.senlin = {
          tooltip: {},
          backgroundColor: 'white',
          animationDurationUpdate: 1500,
          animationEasingUpdate: 'quinticInOut',

          series : [
              {
                  type: 'graph',
                  layout: 'none',
                  symbolSize: function(v,p){
                    return [40/p.data.ceng, 20/p.data.ceng];
                  },
                  symbol: "rect",
                  roam: true,
                  label: {
                      normal: {
                          show: false//true
                      }
                  },
                  edgeSymbol: [, 'arrow'],
                  edgeSymbolSize: [4, 7],
                  data: dian,
                  // links: [],
                  links: bian,
                  lineStyle: {
                      normal: {
                          opacity: 0.9,
                          width: 2,
                          curveness: 0
                      }
                  }
              }
          ]
        };

        $scope.liangxing = {
          title: [
              {
                  text: '良性API调用次数对比',
                  left: 'center',
                  top:'5%',
                  show: false
              }
          ],
          tooltip: {
              trigger: 'item',
              axisPointer: {
                  type: 'shadow'
              }
          },
          grid: {
              left: '8%',
              right: '8%',
              bottom: '10%',
              top:'10%'
          },
          xAxis: {
              type: 'category',
              name: 'API ID',
              data: $scope.shuju.boxplot_x_benign,
              boundaryGap: true,
              nameGap: 30,
              splitArea: {
                  show: false
              },
              splitLine: {
                  show: false
              }
          },
          yAxis: {
              type: 'log',
              name: '调用次数',
              splitArea: {
                  show: false
              }
          },
          backgroundColor:'white',//55kai
          series: [
              {
                  name: 'boxplot',
                  type: 'boxplot',
                  data: $scope.shuju.boxplot_y_benign,
                  tooltip: {
                      formatter: function (param) {
                          return [
                              'API ID: ' + param.name,
                              '最大值: ' + param.data[4],
                              '较大四分位数: ' + param.data[3],
                              '中位数: ' + param.data[2],
                              '较小四分位数: ' + param.data[1],
                              '最低值: ' + param.data[0]
                          ].join('<br/>')
                      }
                  },
                  itemStyle: {
                    normal: {
                      borderColor: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [{
                            offset: 1, color: '#0096ff' // 0% 处的颜色
                        }, {
                            offset: 0, color: '#1797be' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                      },
                      color: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [{
                            offset: 1, color: '#c9f2ff' // 0% 处的颜色
                        }, {
                            offset: 0, color: 'white' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                      }
                    }
                  },
                  zlevel: 1
              },
              {
                  name: '调用次数',
                  type: 'effectScatter',
                  data: $scope.shuju.apk_data,
                  itemStyle: {
                    normal: {
                      color: '#0066c0'
                    }
                  },
                  tooltip: {
                      formatter: function (param) {
                          return ('调用次数: ' + param.data[1]);
                      }
                  },
                  zlevel: 2

              }
          ]
        };
        $scope.exing = {
          title: [
              {
                  text: '恶性API调用次数对比',
                  left: 'center',
                  top:'5%',
                  show: false
              }
          ],
          tooltip: {
              trigger: 'item',
              axisPointer: {
                  type: 'shadow'
              }
          },
          grid: {
              left: '8%',
              right: '8%',
              bottom: '10%',
              top:'10%'
          },
          xAxis: {
              type: 'category',
              name: 'API ID',
              data: $scope.shuju.boxplot_x_malware,
              boundaryGap: true,
              nameGap: 30,
              splitArea: {
                  show: false
              },
              splitLine: {
                  show: false
              }
          },
          yAxis: {
              type: 'log',
              name: '调用次数',
              splitArea: {
                  show: false
              }
          },
          backgroundColor:'white',
          series: [
              {
                  name: 'boxplot',
                  type: 'boxplot',
                  data: $scope.shuju.boxplot_y_malware,
                  tooltip: {
                      formatter: function (param) {
                          return [
                              'API ID: ' + param.name,
                              '最大值: ' + param.data[4],
                              '较大四分位数: ' + param.data[3],
                              '中位数: ' + param.data[2],
                              '较小四分位数: ' + param.data[1],
                              '最低值: ' + param.data[0]
                          ].join('<br/>')
                      }
                  },
                  itemStyle: {
                    normal: {
                      borderColor: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [{
                            offset: 1, color: '#f40000' // 0% 处的颜色
                        }, {
                            offset: 0, color: '#d90000' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                      },
                      color: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [{
                            offset: 1, color: '#ff8282' // 0% 处的颜色
                        }, {
                            offset: 0, color: 'white' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                      }
                    }
                  },
                  zlevel: 1
              },
              {
                  name: '调用次数',
                  type: 'effectScatter',
                  data: $scope.shuju.apk_data,
                  itemStyle: {
                    normal: {
                      color: '#ff0000'
                    }
                  },
                  tooltip: {
                      formatter: function (param) {
                          return ('调用次数: ' + param.data[1]);
                      }
                  },
                  zlevel: 2

              }
          ]
        };

        var apiSet = [];
        for (var i=0; i<$scope.shuju.result.apis.length;++i)
          apiSet.push([
            $scope.shuju.result.apis[i].index,
            $scope.shuju.result.apis[i].package,
            $scope.shuju.result.apis[i].method,
            $scope.shuju.result.apis[i].num
            ])
        $scope.apixiangqing = {
            "data": apiSet,
            "columns": [
                { "title": "API ID" },
                { "title": "所用库/包" },
                { "title": "调用函数" },
                { "title": "调用次数"},
            ]
        };

        var quanxianzhou = [];
        var quanxianliangxingy = [];
        var quanxianexingy = [];
        for (var i=0; i<$scope.shuju.result.permissions.length;++i) {
          quanxianzhou.push($scope.shuju.result.permissions[i].permission);
          quanxianliangxingy.push($scope.shuju.result.permissions[i].benign_rate);
          quanxianexingy.push($scope.shuju.result.permissions[i].malware_rate);
        }
        $scope.quanxianduibi = {
          title: {
              text: '权限使用情况对比',
              left: 'center',
              top:'5%',
              show:false
          },
          tooltip: {
              trigger: 'axis',
              axisPointer: {
                  type: 'shadow'
              }
          },
          legend: {
              data: ['良性应用', '恶性应用'],
              top:'0%'
          },
          grid: {
              left: '8%',
              right: '8%',
              bottom: '20%',
              top:'10%',
              containLabel: true
          },
          backgroundColor:'white',
          xAxis: {
              type: 'category',
              data: quanxianzhou,
              axisLabel: {
                interval: 0,
                rotate: 30
              }
          },
          yAxis: {
              type: 'value',
              boundaryGap: [0, 0.01]
          },
          series: [
              {
                  name: '良性应用',
                  type: 'bar',
                  data: quanxianliangxingy,
                  itemStyle: {
                    normal: {
                      borderColor: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [{
                            offset: 1, color: '#0096ff' // 0% 处的颜色
                        }, {
                            offset: 0, color: '#1797be' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                      },
                      color: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [{
                            offset: 1, color: '#1f9eff' // 0% 处的颜色
                        }, {
                            offset: 0, color: 'white' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                      }
                    }
                  }
              },
              {
                  name: '恶性应用',
                  type: 'bar',
                  data: quanxianexingy,
                  itemStyle: {
                    normal: {
                      borderColor: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [{
                            offset: 1, color: '#f40000' // 0% 处的颜色
                        }, {
                            offset: 0, color: '#d90000' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                      },
                      color: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [{
                            offset: 1, color: '#ff8282' // 0% 处的颜色
                        }, {
                            offset: 0, color: 'white' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                      }
                    }
                  }
              }
          ]
        };

        var quanxianSet = [];
        for (var i=0; i<$scope.shuju.result.permissions.length;++i)
          quanxianSet.push([
            $scope.shuju.result.permissions[i].index,
            $scope.shuju.result.permissions[i].permission,
            $scope.shuju.result.permissions[i].benign_count+"/"+$scope.shuju.result.permissions[i].benign_total,
            $scope.shuju.result.permissions[i].malware_count+"/"+$scope.shuju.result.permissions[i].malware_total,
            ])
        $scope.quanxianxiangqing = {
            "data": quanxianSet,
            "columns": [
                { "title": "权限ID" },
                { "title": "权限名称" },
                { "title": "良性应用中使用率" },
                { "title": "恶性应用中使用率"},
            ]
        };


      }).error(function(data,header,config,status){
        //处理响应失败
    });



})
