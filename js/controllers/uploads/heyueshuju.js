var mysql = require('mysql');
var Web3 = require('web3');

var web3 = new Web3();

var pool = mysql.createPool({
    host: '192.168.152.1',
    user: 'root',
    password: '',
    database:'ethwithcontract',
    port: 3306
});

web3.setProvider(new web3.providers.HttpProvider('http://192.168.152.1:8545'));

console.log("eth2");

var getshu = 0;
var hehe = 100;
var hehe2= 200;
hehe *= 10000;
hehe2 *= 10000;


function huoqublock(blockid) {
    web3.eth.getBlock(blockid, true, function(error, getblock){

    	getshu--;

    	//console.log(getblock);

		if (error) console.log(error);

		if (getblock.number%100==0) console.log("getdaole",getblock.number,getblock.transactions.length);

	    if (getblock.transactions.length!=0)
		    for (tx in getblock.transactions) {
		    	var newcontract = null;
	    		if (getblock.transactions[tx].to==null) {
	    			newcontract = web3.eth.getTransactionReceipt(getblock.transactions[tx].hash);
	    			console.log("!!!",newcontract);
	    		}
	    		var sql = "INSERT INTO tx VALUES('"+getblock.number+"','"+getblock.timestamp+"','"+getblock.transactions[tx].hash+"','"+getblock.transactions[tx].from+"','"+getblock.transactions[tx].nonce+"','"+getblock.transactions[tx].to+"','"+newcontract+"','"+getblock.transactions[tx].input+"','"+getblock.transactions[tx].value+"','"+getblock.transactions[tx].gas+"','"+getblock.transactions[tx].gasPrice+"')";
	    		


				getshu++;

	    		pool.query(sql, function(err, result){

					getshu--;
					if(err) console.log(err);

	    			if (getblock.number%100==0) console.log("charule",getblock.number);
			        if (getshu==0 && hehe<hehe2) {
						hehe += 10000;
						huoqu10000();
					}

			    });
		    }

        if (getshu==0 && hehe<hehe2) {
        	hehe += 10000;
        	huoqu10000();
        }


    });
}

function huoqu10000() {
	console.log("kaishi ",hehe);
	for (var i=hehe;i<hehe+10000;++i) {
		getshu++;
		huoqublock(i);
	}

}

//huoqu10000();
huoqublock(3434808);